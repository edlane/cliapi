## Guide for CLIAPI Plugin Developers:
**cliapi** ( pronounced _calliope_ ): A Python framework for creating Unix, "getopt()" style CLI scripts
composed from an arbitrary set of APIs.

...at its core, **cliapi** is _a data driven, state machine for dynamically generating CLIs_.

### cliapi features:
- entire CLI is generated by applying python decorators to API calls together with a dictionary which
specifies a _backing-API-store_. 
This decorator is applied to each API that is supported by a "plugin provider".
For each cloud provider (eg. Azure or GCE) a supporting "plugin" module is added to the
`cliapi/providers` directory (see **`cliapi directory layout`** below)
Presumably the plugin developer will rarely need to change the cliapi framework
itself which involves a little python meta-programming (1 decorator + 1 dictionary
overriding class).

- consistent command line behavior is enforced by the cliapi framework across all plugin providers.
Several common commands are automatically inherited by all plugin providers:
(this allows a level of "discoverablility" to the CLI across all plugin providers)
  - "**--list-providers**" Lists all the available plugin providers.
  - "**--provider=**" specify a particular provider plugin for all CLI commands.
  - "**--all**" Lists all data returned by all APIs supported by a single provider.
  - "**--list-apis**" Lists all the APIs available by a particular plugin provider.
  - "**--item=**" Display an item from API by it's right-most JSON path specifier.  
  For example:  
    - "**--item=location**" will return the value for **meta_data.compute.location**
    - "**--item=privateIpAddress**" will return a list of all keys ending in "**privateIpAddress**"  
    to get a particular element from a list the item should be referenced using it's unique right-most JSON path name, **i.e**:   
    ```
    root # azuremetadata --item=interface[0].macAddress
    "000D3A3AE8A5"
    ```
- other behaviors enforced by the cliapi framework:
  - flexible provider handling based on the way cliapi is invoked:  
    - if invoked using "cliapi" name then API provider defaults to first valid plugin imported.
    - if invoked using _non-cliapi_ name then API provider defaults to the plugin provider with same _non-cliapi_ name.
    - the default provider can be over ridden using "--provider=" config option.
  - error handling and help is also consistent across all plugin providers.
  - multiple queries in same command will return a JSON list in "option order" by default
  - single query will return a single JSON element.

- multiple data queries within the same CLI will result in "at most" a single API call.

### Key cliapi plugin developer concepts:

An example cliapi plugin provider for Azuremeta API + SUSE extensions can be found here:
https://github.com/edlane/cliapi/blob/master/cliapi/providers/azure.py

- **provider**:  an associated set of APIs accessed from the CLI in a particular context or cloud
 environment e.g. "azure", "gce", "ec2", ... but can essentially be any mix of apis

- **api**: an API for interfacing to remote or local services.  If the interface can be implemented as
a python function with an (_*args, **kwargs_) style calling convention AND it returns a JSON serializable
object, THEN it can easily become a configurable CLI query.  With the cliapi decorator, both required and
optional parameters are expressible through the CLI.  Help is also handled by the cliapi framework.

- **fetchers**: a dictionary which maps from a particular API name to the actual python function which
provides the _backing store_ for the contents of the top-level API dictionary.

### cliapi directory layout:
```
├── cliapi                      root of cliapi package
│   ├── __init__.py
│   ├── cliapi_lib.py           framework meta classes and decorators
│   ├── cliapi.py               main() and the CLI generation code
│   └── what_cloud.py           module (useful for detecting which cloud plugins are valid)
│   ├── providers               directory for plugin providers
│   │   ├── __init__.py
│   │   ├── azuremetadata.py            plugin for Azure/SUSE APIs
│   │   ├── <your plugin here>  ...your plugin goes here
│   │   ├── ...                 ...additional plugins are automatically discovered by cliapi
│   │   └── test.py             ..."because it's not a framework without at least 2 plugins"
├── design.md                   design considerations for cliapi
├── LICENSE                     provisional license (Apache2 is mutable into any other license)
├── README.md                   this document
└── setup.py                    Python installation script
```

### Examples:

**example #1** - Common help AND plugin provider help
```
ed-sle12sp3byos:/home/lane/cliapi # azuremetadata --help
usage: ./azuremetadata --item=[API display item #1]... [API config option#1]... [API required options]... [Common CLI options]...

***[ azuremetadata ]*** provider Display options:
     cloud-service
               privateIpAddress
               publicIpAddress
               address
               prefix
           macAddress
         osType
         version
         placementGroupId
         vmId
         sku
         platformUpdateDomain
         subscriptionId
         offer
         name
         tags
         resourceGroupName
         vmSize
         publisher
         platformFaultDomain
         location
     tag

***[ azuremetadata ]*** provider API config options:
  --api_version=     default='2017-08-01'

Common CLI options:
  --list-apis        list all available APIs for specified provider
  --item=            value to return from an API using right-most path name specifier
  --list-providers   list all available providers
  --help             help for this CLI command
  --all              output all API results for a specific provider
  --provider=        specify name of provider module

```
---
**example #2** - a single display item
```
ed-sle12sp3byos:/home/lane/cliapi # azuremetadata --item=privateIpAddress
"172.16.3.8"
```
---
**example #3** - all values returned by azuremetadata APIs
```
ed-sle12sp3byos:/home/lane/cliapi # ./azuremetadata --all
{
  "meta_data": {
    "network": {
      "interface": [
        {
          "macAddress": "000D3A3AE8A5",
          "ipv4": {
            "subnet": [
              {
                "address": "172.16.3.0",
                "prefix": "24"
              }
            ],
            "ipAddress": [
              {
                "privateIpAddress": "172.16.3.8",
                "publicIpAddress": "40.112.253.198"
              }
            ]
          },
          "ipv6": {
            "ipAddress": []
          }
        }
      ]
    },
    "compute": {
      "offer": "SLES-BYOS",
      "placementGroupId": "",
      "publisher": "SUSE",
      "sku": "12-SP3",
      "osType": "Linux",
      "platformFaultDomain": "0",
      "platformUpdateDomain": "0",
      "tags": "",
      "vmSize": "Standard_B1ms",
      "location": "westus",
      "name": "ed-sle12sp3byos",
      "subscriptionId": "ce73a2b0-d2e7-4ff6-b987-b32d6908de4e",
      "version": "2018.02.21",
      "vmId": "ce01dc32-6d0a-40bd-9534-a3509f768a53",
      "resourceGroupName": "ed_lane"
    }
  },
  "cloud-service": "__ed-sle12sp3byosService.cloudapp.net",
  "tag": "391e4f53-b82d-5af5-8f58-dc1035e46e5e"
}
```
---
**example #4** - list of valid plugin providers
```
ed-sle12sp3byos:/home/lane/cliapi # azuremetadata --list-providers
[
  "test",
  "azuremetadata"
]
```
---
**example #5** - list of APIs supported by plugin provider
```
ed-sle12sp3byos:/home/lane/cliapi # azuremetadata --list-apis
[
  "tag",
  "cloud-service",
  "meta_data"
]
```
---
**example #6** - return several display items in single call
```
ed-sle12sp3byos:/home/lane/cliapi # ./azuremetadata --item=privateIpAddress --item=publisher --item=vmSize --item=location --item=name --item=offer --item=interface[0].macAddress
[
  "172.16.3.8",
  "SUSE",
  "Standard_B1ms",
  "westus",
  "ed-sle12sp3byos",
  "SLES-BYOS",
  "000D3A3AE8A5"
]
```

